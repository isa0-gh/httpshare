<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>httpshare - {{.Path}}</title>
  <script src="/tailwind.js"></script>
  <style>
    :root[data-theme="light"] {
      --bg-primary: #ffffff;
      --bg-secondary: #f3f4f6;
      --bg-tertiary: #e5e7eb;
      --text-primary: #111827;
      --text-secondary: #6b7280;
      --accent: #3b82f6;
      --border: #d1d5db;
    }
    :root[data-theme="dark"] {
      --bg-primary: #111827;
      --bg-secondary: #1f2937;
      --bg-tertiary: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #9ca3af;
      --accent: #fbbf24;
      --border: #4b5563;
    }
    body {
      background-color: var(--bg-primary);
      color: var(--text-primary);
      transition: background-color 0.3s, color 0.3s;
    }
    .modal { display: none; }
    .modal.active { display: flex; }
    .gallery-image { 
      max-height: 80vh; 
      max-width: 90vw; 
      object-fit: contain; 
    }
    .markdown-body {
      color: var(--text-primary);
      line-height: 1.6;
    }
    .markdown-body h1, .markdown-body h2, .markdown-body h3 {
      color: var(--accent);
      margin-top: 1.5rem;
      margin-bottom: 0.75rem;
    }
    .markdown-body code {
      background: var(--bg-tertiary);
      padding: 0.2rem 0.4rem;
      border-radius: 0.25rem;
      font-size: 0.875rem;
    }
    .markdown-body pre {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: 0.5rem;
      overflow-x: auto;
    }
    .markdown-body pre code {
      background: transparent;
      padding: 0;
    }
    .markdown-body a {
      color: #60a5fa;
      text-decoration: underline;
    }
    .markdown-body ul, .markdown-body ol {
      margin-left: 1.5rem;
      margin-bottom: 1rem;
    }
    .markdown-body blockquote {
      border-left: 4px solid var(--accent);
      padding-left: 1rem;
      color: var(--text-secondary);
      margin: 1rem 0;
    }
    .file-row.selected {
      background-color: var(--bg-tertiary) !important;
    }
    .btn {
      transition: all 0.2s;
    }
    .btn:hover {
      transform: translateY(-1px);
    }
    .playlist-item {
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 0.25rem;
    }
    .playlist-item:hover {
      background: var(--bg-tertiary);
    }
    .playlist-item.active {
      background: var(--accent);
      color: var(--bg-primary);
    }
  </style>
</head>
<body class="min-h-screen font-sans">

  <div class="max-w-7xl mx-auto p-6">

    <!-- Header with Navigation and Actions -->
    <div class="mb-6 space-y-4">
      <!-- Top Bar -->
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3 text-lg">
          <a id="up-directory" href="#" class="hover:text-yellow-400 flex items-center transition">
            <span class="mr-1">‚¨ÜÔ∏è</span> ../
          </a>
          <span class="text-yellow-400">üìÇ {{.Path}}</span>
        </div>
        
        <!-- Theme Switcher -->
        <div class="flex items-center space-x-2">
          <button onclick="setTheme('light')" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Light Theme">
            ‚òÄÔ∏è
          </button>
          <button onclick="setTheme('dark')" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Dark Theme">
            üåô
          </button>
          <button onclick="setTheme('auto')" class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700" title="Auto Theme">
            üîÑ
          </button>
        </div>
      </div>

      <!-- Search, Sort, and Actions -->
      <div class="flex flex-wrap gap-3 items-center">
        <!-- Search -->
        <input type="text" id="searchInput" placeholder="üîç Search files..." 
               class="bg-gray-800 px-4 py-2 rounded-lg flex-1 min-w-[200px] focus:outline-none focus:ring-2 focus:ring-yellow-400">
        
        <!-- Sort -->
        <select id="sortBy" class="bg-gray-800 px-4 py-2 rounded-lg focus:outline-none focus:ring-2 focus:ring-yellow-400">
          <option value="">Sort by...</option>
          <option value="name">Name</option>
          <option value="size">Size</option>
          <option value="date">Date</option>
        </select>

        <!-- Actions -->
        <button onclick="openUploadModal()" class="btn bg-blue-600 hover:bg-blue-700 px-4 py-2 rounded-lg transition">
          üì§ Upload
        </button>
        <button onclick="openMkdirModal()" class="btn bg-green-600 hover:bg-green-700 px-4 py-2 rounded-lg transition">
          üìÅ New Folder
        </button>
        <button onclick="openGallery()" class="btn bg-purple-600 hover:bg-purple-700 px-4 py-2 rounded-lg transition">
          üñºÔ∏è Gallery
        </button>
        <button onclick="openPlaylist()" class="btn bg-pink-600 hover:bg-pink-700 px-4 py-2 rounded-lg transition">
          üéµ Playlist
        </button>
        <button onclick="bulkActions()" class="btn bg-orange-600 hover:bg-orange-700 px-4 py-2 rounded-lg transition" id="bulkBtn" style="display:none;">
          ‚ö° Bulk Actions
        </button>
      </div>
    </div>

    <!-- Files Table -->
    <div class="bg-gray-800 rounded-lg overflow-hidden">
      <table class="w-full">
        <thead class="bg-gray-700">
          <tr>
            <th class="px-4 py-3 text-left">
              <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
            </th>
            <th class="px-4 py-3 text-left">Name</th>
            <th class="px-4 py-3 text-left hidden md:table-cell">Size</th>
            <th class="px-4 py-3 text-left hidden lg:table-cell">Modified</th>
            <th class="px-4 py-3 text-left hidden lg:table-cell">Permissions</th>
            <th class="px-4 py-3 text-right">Actions</th>
          </tr>
        </thead>
        <tbody id="fileList">
          {{range .Entries}}
          <tr class="file-row border-t border-gray-700 hover:bg-gray-750 transition" data-name="{{.Name}}" data-is-dir="{{.IsDir}}" data-is-image="{{.IsImage}}" data-is-video="{{.IsVideo}}" data-is-audio="{{.IsAudio}}">
            <td class="px-4 py-3">
              <input type="checkbox" class="file-checkbox" data-path="{{.Name}}" onchange="updateBulkButton()">
            </td>
            <td class="px-4 py-3">
              <div class="flex items-center space-x-2">
                {{if .IsDir}}
                  <span class="text-2xl">üìÅ</span>
                  <a href="{{.Name}}/" class="hover:text-yellow-400 truncate">{{.Name}}</a>
                {{else if .IsImage}}
                  <span class="text-2xl">üñºÔ∏è</span>
                  <a href="#" onclick="event.preventDefault(); openImageInGallery('{{.Name}}');" class="hover:text-yellow-400 truncate">{{.Name}}</a>
                {{else if isVideo .Name}}
                  <span class="text-2xl">üé¨</span>
                  <a href="#" onclick="event.preventDefault(); previewFile('{{.Name}}');" class="hover:text-yellow-400 truncate">{{.Name}}</a>
                {{else if isAudio .Name}}
                  <span class="text-2xl">üéµ</span>
                  <a href="#" onclick="event.preventDefault(); addToPlaylist('{{.Name}}');" class="hover:text-yellow-400 truncate">{{.Name}}</a>
                {{else}}
                  <span class="text-2xl">üìÑ</span>
                  <a href="{{.Name}}/?download=true" class="hover:text-yellow-400 truncate">{{.Name}}</a>
                {{end}}
              </div>
            </td>
            <td class="px-4 py-3 text-gray-400 hidden md:table-cell">
              {{if .IsDir}}-{{else}}{{formatSize .Size}}{{end}}
            </td>
            <td class="px-4 py-3 text-gray-400 hidden lg:table-cell">
              {{.ModTime.Format "2006-01-02 15:04"}}
            </td>
            <td class="px-4 py-3 text-gray-400 font-mono text-sm hidden lg:table-cell">
              {{.Permissions}}
            </td>
            <td class="px-4 py-3 text-right">
              <div class="flex justify-end space-x-2">
                {{if canPreview .Name}}
                <button onclick="previewFile('{{.Name}}')" class="text-blue-400 hover:text-blue-300 text-sm" title="Preview">
                  üëÅÔ∏è
                </button>
                {{end}}
                <button onclick="shareFile('{{.Name}}')" class="text-green-400 hover:text-green-300 text-sm" title="Share">
                  üîó
                </button>
                <button onclick="downloadZip('{{.Name}}')" class="text-purple-400 hover:text-purple-300 text-sm" title="Download as ZIP">
                  üì¶
                </button>
                <button onclick="showComments('{{.Name}}')" class="text-cyan-400 hover:text-cyan-300 text-sm" title="Comments">
                  üí¨
                </button>
                <button onclick="renameItem('{{.Name}}')" class="text-yellow-400 hover:text-yellow-300 text-sm" title="Rename">
                  ‚úèÔ∏è
                </button>
                <button onclick="deleteItem('{{.Name}}')" class="text-red-400 hover:text-red-300 text-sm" title="Delete">
                  üóëÔ∏è
                </button>
              </div>
            </td>
          </tr>
          {{end}}
        </tbody>
      </table>
    </div>

  </div>

  <!-- Upload Modal -->
  <div id="uploadModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">Upload File</h2>
      <form id="uploadForm" enctype="multipart/form-data">
        <input type="file" id="fileInput" multiple class="w-full mb-4 text-gray-300">
        <div id="uploadProgress" class="hidden mb-4">
          <div class="w-full bg-gray-700 rounded-full h-2.5">
            <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
          </div>
          <p id="progressText" class="text-sm text-gray-400 mt-2">Uploading...</p>
        </div>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeUploadModal()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
            Upload
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Mkdir Modal -->
  <div id="mkdirModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">Create New Folder</h2>
      <form id="mkdirForm">
        <input type="text" id="folderName" placeholder="Folder name" 
               class="w-full mb-4 px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400">
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeMkdirModal()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
            Cancel
          </button>
          <button type="submit" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">
            Create
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Preview Modal -->
  <div id="previewModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h2 id="previewTitle" class="text-xl font-bold">Preview</h2>
        <button onclick="closePreviewModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div id="previewContent" class="p-4"></div>
    </div>
  </div>

  <!-- Gallery Modal -->
  <div id="galleryModal" class="modal fixed inset-0 bg-black bg-opacity-95 items-center justify-center z-50">
    <button onclick="closeGallery()" class="absolute top-4 right-4 text-white text-4xl z-50 hover:text-gray-300">&times;</button>
    
    <button onclick="prevImage()" class="absolute left-4 text-white text-5xl z-50 hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-16 h-16 flex items-center justify-center">
      ‚Äπ
    </button>
    
    <button onclick="nextImage()" class="absolute right-4 text-white text-5xl z-50 hover:text-gray-300 bg-black bg-opacity-50 rounded-full w-16 h-16 flex items-center justify-center">
      ‚Ä∫
    </button>

    <div class="text-center">
      <img id="galleryImage" src="" alt="" class="gallery-image mx-auto">
      <div class="mt-4 text-white">
        <p id="galleryImageName" class="text-xl font-bold"></p>
        <p id="galleryCounter" class="text-gray-400 mt-2"></p>
      </div>
    </div>
  </div>

  <!-- Playlist Modal -->
  <div id="playlistModal" class="modal fixed inset-0 bg-black bg-opacity-75 items-center justify-center p-4 z-50">
    <div class="bg-gray-800 rounded-lg max-w-4xl w-full max-h-[90vh] overflow-auto">
      <div class="p-4 border-b border-gray-700 flex justify-between items-center">
        <h2 class="text-xl font-bold">üéµ Music Playlist</h2>
        <button onclick="closePlaylist()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
      </div>
      <div class="p-4">
        <div class="mb-4">
          <audio id="audioPlayer" controls class="w-full"></audio>
        </div>
        <div id="playlistItems" class="space-y-2 max-h-96 overflow-y-auto"></div>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">Share File</h2>
      <div class="space-y-4">
        <div>
          <label class="block text-sm mb-2">Expires in (hours, leave empty for permanent)</label>
          <input type="number" id="shareExpiry" placeholder="24" 
                 class="w-full px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-400">
        </div>
        <div id="shareResult" class="hidden">
          <label class="block text-sm mb-2">Share Link:</label>
          <div class="flex space-x-2">
            <input type="text" id="shareLink" readonly 
                   class="flex-1 px-4 py-2 bg-gray-700 rounded-lg focus:outline-none">
            <button onclick="copyShareLink()" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
              üìã Copy
            </button>
          </div>
        </div>
        <div class="flex justify-end space-x-3">
          <button onclick="closeShareModal()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
            Close
          </button>
          <button onclick="createShare()" id="createShareBtn" class="px-4 py-2 bg-green-600 rounded-lg hover:bg-green-700">
            Create Link
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Comments Modal -->
  <div id="commentsModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-2xl w-full mx-4 max-h-[80vh] overflow-auto">
      <h2 class="text-xl font-bold mb-4">üí¨ Comments</h2>
      <div id="commentsList" class="space-y-3 mb-4 max-h-64 overflow-y-auto"></div>
      <form id="commentForm" class="space-y-3">
        <input type="text" id="commentAuthor" placeholder="Your name (optional)" 
               class="w-full px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400">
        <textarea id="commentContent" placeholder="Write a comment..." rows="3"
                  class="w-full px-4 py-2 bg-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
        <div class="flex justify-end space-x-3">
          <button type="button" onclick="closeCommentsModal()" class="px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
            Close
          </button>
          <button type="submit" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700">
            Add Comment
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bulk Actions Modal -->
  <div id="bulkModal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
    <div class="bg-gray-800 p-6 rounded-lg max-w-md w-full mx-4">
      <h2 class="text-xl font-bold mb-4">Bulk Actions</h2>
      <div class="space-y-3">
        <button onclick="bulkDownloadZip()" class="w-full px-4 py-2 bg-purple-600 rounded-lg hover:bg-purple-700">
          üì¶ Download Selected as ZIP
        </button>
        <button onclick="bulkDelete()" class="w-full px-4 py-2 bg-red-600 rounded-lg hover:bg-red-700">
          üóëÔ∏è Delete Selected
        </button>
        <button onclick="closeBulkModal()" class="w-full px-4 py-2 bg-gray-700 rounded-lg hover:bg-gray-600">
          Cancel
        </button>
      </div>
    </div>
  </div>

  <script>
    // Theme Management
    function setTheme(theme) {
      localStorage.setItem('theme', theme);
      applyTheme(theme);
    }

    function applyTheme(theme) {
      if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        document.documentElement.setAttribute('data-theme', prefersDark ? 'dark' : 'light');
      } else {
        document.documentElement.setAttribute('data-theme', theme);
      }
    }

    // Load saved theme
    const savedTheme = localStorage.getItem('theme') || 'dark';
    applyTheme(savedTheme);

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Ctrl/Cmd + U for upload
      if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
        e.preventDefault();
        openUploadModal();
      }
      // Ctrl/Cmd + N for new folder
      if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
        e.preventDefault();
        openMkdirModal();
      }
      // Ctrl/Cmd + A for select all
      if ((e.ctrlKey || e.metaKey) && e.key === 'a') {
        e.preventDefault();
        document.getElementById('selectAll').checked = true;
        toggleSelectAll();
      }
      // Escape to close modals
      if (e.key === 'Escape') {
        closeAllModals();
      }
    });

    function closeAllModals() {
      document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    }

    // Markdown parser
    function parseMarkdown(text) {
      let html = text
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
      
      html = html.replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>');
      html = html.replace(/^#### (.*$)/gim, '<h4>$1</h4>');
      html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
      html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
      html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
      html = html.replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>');
      html = html.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
      html = html.replace(/\*(.+?)\*/g, '<em>$1</em>');
      html = html.replace(/___(.+?)___/g, '<strong><em>$1</em></strong>');
      html = html.replace(/__(.+?)__/g, '<strong>$1</strong>');
      html = html.replace(/_(.+?)_/g, '<em>$1</em>');
      html = html.replace(/`(.+?)`/g, '<code>$1</code>');
      html = html.replace(/\[(.+?)\]\((.+?)\)/g, '<a href="$2" target="_blank">$1</a>');
      html = html.replace(/!\[(.+?)\]\((.+?)\)/g, '<img src="$2" alt="$1" class="max-w-full h-auto">');
      
      const lines = html.split('\n');
      let inList = false;
      let listType = '';
      let result = [];
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const ulMatch = line.match(/^[\s]*[-*+] (.+)/);
        const olMatch = line.match(/^[\s]*\d+\. (.+)/);
        
        if (ulMatch) {
          if (!inList || listType !== 'ul') {
            if (inList) result.push(`</${listType}>`);
            result.push('<ul>');
            inList = true;
            listType = 'ul';
          }
          result.push(`<li>${ulMatch[1]}</li>`);
        } else if (olMatch) {
          if (!inList || listType !== 'ol') {
            if (inList) result.push(`</${listType}>`);
            result.push('<ol>');
            inList = true;
            listType = 'ol';
          }
          result.push(`<li>${olMatch[1]}</li>`);
        } else {
          if (inList) {
            result.push(`</${listType}>`);
            inList = false;
            listType = '';
          }
          result.push(line);
        }
      }
      if (inList) result.push(`</${listType}>`);
      html = result.join('\n');
      
      html = html.replace(/^&gt; (.+$)/gim, '<blockquote>$1</blockquote>');
      html = html.replace(/^---$/gim, '<hr>');
      html = html.replace(/^\*\*\*$/gim, '<hr>');
      html = html.replace(/\n\n/g, '</p><p>');
      html = html.replace(/\n/g, '<br>');
      html = '<p>' + html + '</p>';
      html = html.replace(/<p><\/p>/g, '');
      html = html.replace(/<p><br>/g, '<p>');
      html = html.replace(/<br><\/p>/g, '</p>');
      
      return html;
    }

    const currentPath = window.location.pathname;
    const upLink = document.getElementById('up-directory');

    // Setup navigation
    if (currentPath !== "/") {
      const trimmedPath = currentPath.endsWith('/') ? currentPath.slice(0, -1) : currentPath;
      const parent = trimmedPath.substring(0, trimmedPath.lastIndexOf('/') + 1) || "/";
      upLink.href = parent;
    } else {
      upLink.style.display = 'none';
    }

    // Search functionality
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const rows = document.querySelectorAll('#fileList tr');
      rows.forEach(row => {
        const name = row.getAttribute('data-name').toLowerCase();
        row.style.display = name.includes(query) ? '' : 'none';
      });
    });

    // Sort functionality
    document.getElementById('sortBy').addEventListener('change', (e) => {
      const sortBy = e.target.value;
      if (sortBy) {
        const url = new URL(window.location);
        url.searchParams.set('sort', sortBy);
        url.searchParams.set('order', 'asc');
        window.location = url;
      }
    });

    // Selection
    function toggleSelectAll() {
      const checked = document.getElementById('selectAll').checked;
      document.querySelectorAll('.file-checkbox').forEach(cb => {
        cb.checked = checked;
        if (checked) {
          cb.closest('tr').classList.add('selected');
        } else {
          cb.closest('tr').classList.remove('selected');
        }
      });
      updateBulkButton();
    }

    function updateBulkButton() {
      const selected = document.querySelectorAll('.file-checkbox:checked').length;
      const bulkBtn = document.getElementById('bulkBtn');
      if (selected > 0) {
        bulkBtn.style.display = 'block';
        bulkBtn.textContent = `‚ö° Bulk Actions (${selected})`;
      } else {
        bulkBtn.style.display = 'none';
      }
      
      // Update row styling
      document.querySelectorAll('.file-checkbox').forEach(cb => {
        if (cb.checked) {
          cb.closest('tr').classList.add('selected');
        } else {
          cb.closest('tr').classList.remove('selected');
        }
      });
    }

    function getSelectedFiles() {
      const selected = [];
      document.querySelectorAll('.file-checkbox:checked').forEach(cb => {
        selected.push(cb.getAttribute('data-path'));
      });
      return selected;
    }

    // Upload
    function openUploadModal() {
      document.getElementById('uploadModal').classList.add('active');
    }
    function closeUploadModal() {
      document.getElementById('uploadModal').classList.remove('active');
      document.getElementById('uploadProgress').classList.add('hidden');
      document.getElementById('progressBar').style.width = '0%';
    }
    
    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const files = document.getElementById('fileInput').files;
      if (files.length === 0) return;

      const progressDiv = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      progressDiv.classList.remove('hidden');

      for (let i = 0; i < files.length; i++) {
        const formData = new FormData();
        formData.append('file', files[i]);
        formData.append('path', currentPath === '/' ? '.' : currentPath.substring(1));
        
        progressText.textContent = `Uploading ${i + 1}/${files.length}: ${files[i].name}`;
        progressBar.style.width = `${((i + 1) / files.length) * 100}%`;

        const res = await fetch('/api/upload', { method: 'POST', body: formData });
        if (!res.ok) {
          alert(`Failed to upload ${files[i].name}`);
        }
      }

      location.reload();
    });

    // Drag and drop upload
    document.body.addEventListener('dragover', (e) => {
      e.preventDefault();
      e.stopPropagation();
    });

    document.body.addEventListener('drop', async (e) => {
      e.preventDefault();
      e.stopPropagation();
      
      const files = e.dataTransfer.files;
      if (files.length === 0) return;

      for (let file of files) {
        const formData = new FormData();
        formData.append('file', file);
        formData.append('path', currentPath === '/' ? '.' : currentPath.substring(1));
        
        await fetch('/api/upload', { method: 'POST', body: formData });
      }

      location.reload();
    });

    // Mkdir
    function openMkdirModal() {
      document.getElementById('mkdirModal').classList.add('active');
    }
    function closeMkdirModal() {
      document.getElementById('mkdirModal').classList.remove('active');
    }
    document.getElementById('mkdirForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const folderName = document.getElementById('folderName').value;
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPath = basePath ? basePath + '/' + folderName : folderName;
      
      const formData = new FormData();
      formData.append('path', fullPath);
      
      const res = await fetch('/api/mkdir', { method: 'POST', body: formData });
      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to create folder');
      }
    });

    // Delete
    async function deleteItem(name) {
      if (!confirm(`Delete ${name}?`)) return;
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPath = basePath ? basePath + '/' + name : name;
      
      const res = await fetch(`/api/delete?path=${encodeURIComponent(fullPath)}`, { method: 'DELETE' });
      if (res.ok) {
        location.reload();
      } else {
        alert('Delete failed');
      }
    }

    // Rename
    async function renameItem(oldName) {
      const newName = prompt('Enter new name:', oldName);
      if (!newName || newName === oldName) return;
      
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const oldPath = basePath ? basePath + '/' + oldName : oldName;
      
      const formData = new FormData();
      formData.append('oldPath', oldPath);
      formData.append('newName', newName);
      
      const res = await fetch('/api/rename', { method: 'POST', body: formData });
      if (res.ok) {
        location.reload();
      } else {
        alert('Rename failed');
      }
    }

    // Preview
    function previewFile(name) {
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPath = basePath ? basePath + '/' + name : name;
      const ext = name.split('.').pop().toLowerCase();
      
      document.getElementById('previewTitle').textContent = name;
      const content = document.getElementById('previewContent');
      
      if (ext === 'md') {
        fetch(`/${fullPath}?download=true`)
          .then(r => r.text())
          .then(text => {
            const html = parseMarkdown(text);
            content.innerHTML = `<div class="markdown-body">${html}</div>`;
          })
          .catch(err => {
            content.innerHTML = `<div class="text-red-400 p-4">Error loading file: ${err.message}</div>`;
          });
      } else if (['txt', 'log', 'json', 'xml', 'csv'].includes(ext)) {
        fetch(`/${fullPath}?download=true`)
          .then(r => r.text())
          .then(text => {
            content.innerHTML = `<pre class="bg-gray-900 p-4 rounded overflow-auto max-h-96">${escapeHtml(text)}</pre>`;
          });
      } else if (ext === 'pdf') {
        content.innerHTML = `<iframe src="/${fullPath}?download=true" class="w-full h-96"></iframe>`;
      } else if (['mp4', 'webm', 'avi', 'mov', 'mkv'].includes(ext)) {
        content.innerHTML = `
          <video controls class="w-full" id="videoPlayer">
            <source src="/${fullPath}?download=true">
            <track kind="subtitles" src="" label="English" default>
          </video>
          <div class="mt-4">
            <label class="block text-sm mb-2">Add Subtitle (VTT file):</label>
            <input type="file" accept=".vtt" onchange="loadSubtitle(event)" class="w-full text-gray-300">
          </div>
        `;
      } else if (['mp3', 'wav', 'ogg', 'flac'].includes(ext)) {
        content.innerHTML = `<audio controls class="w-full"><source src="/${fullPath}?download=true"></audio>`;
      } else if (['docx', 'xlsx', 'pptx'].includes(ext)) {
        content.innerHTML = `
          <div class="text-center p-8">
            <p class="mb-4">Office document preview not available in browser.</p>
            <a href="/${fullPath}?download=true" class="px-4 py-2 bg-blue-600 rounded-lg hover:bg-blue-700 inline-block">
              üì• Download to view
            </a>
            <p class="mt-4 text-sm text-gray-400">Or use: <a href="https://view.officeapps.live.com/op/view.aspx?src=${encodeURIComponent(window.location.origin + '/' + fullPath + '?download=true')}" target="_blank" class="text-blue-400 underline">Office Online Viewer</a></p>
          </div>
        `;
      }
      
      document.getElementById('previewModal').classList.add('active');
    }
    
    function loadSubtitle(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const video = document.getElementById('videoPlayer');
      const track = video.querySelector('track');
      
      const url = URL.createObjectURL(file);
      track.src = url;
      track.label = file.name;
    }
    
    function closePreviewModal() {
      document.getElementById('previewModal').classList.remove('active');
    }
    
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Gallery functionality
    let galleryImages = [];
    let currentImageIndex = 0;

    function openGallery() {
      galleryImages = [];
      const rows = document.querySelectorAll('#fileList tr');
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      
      rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const isImage = row.getAttribute('data-is-image') === 'true';
        if (isImage) {
          const fullPath = basePath ? basePath + '/' + name : name;
          galleryImages.push({ name, path: fullPath });
        }
      });

      if (galleryImages.length === 0) {
        alert('No images found in this directory');
        return;
      }

      currentImageIndex = 0;
      showGalleryImage();
      document.getElementById('galleryModal').classList.add('active');
    }

    function closeGallery() {
      document.getElementById('galleryModal').classList.remove('active');
    }

    function showGalleryImage() {
      if (galleryImages.length === 0) return;
      
      const img = galleryImages[currentImageIndex];
      document.getElementById('galleryImage').src = `/${img.path}?download=true`;
      document.getElementById('galleryImageName').textContent = img.name;
      document.getElementById('galleryCounter').textContent = `${currentImageIndex + 1} / ${galleryImages.length}`;
    }

    function nextImage() {
      if (galleryImages.length === 0) return;
      currentImageIndex = (currentImageIndex + 1) % galleryImages.length;
      showGalleryImage();
    }

    function prevImage() {
      if (galleryImages.length === 0) return;
      currentImageIndex = (currentImageIndex - 1 + galleryImages.length) % galleryImages.length;
      showGalleryImage();
    }

    // Keyboard navigation for gallery
    document.addEventListener('keydown', (e) => {
      if (!document.getElementById('galleryModal').classList.contains('active')) return;
      
      if (e.key === 'ArrowRight') nextImage();
      else if (e.key === 'ArrowLeft') prevImage();
      else if (e.key === 'Escape') closeGallery();
    });

    function openImageInGallery(imageName) {
      galleryImages = [];
      const rows = document.querySelectorAll('#fileList tr');
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      
      rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const isImage = row.getAttribute('data-is-image') === 'true';
        if (isImage) {
          const fullPath = basePath ? basePath + '/' + name : name;
          galleryImages.push({ name, path: fullPath });
        }
      });

      currentImageIndex = galleryImages.findIndex(img => img.name === imageName);
      if (currentImageIndex === -1) currentImageIndex = 0;

      showGalleryImage();
      document.getElementById('galleryModal').classList.add('active');
    }

    // Playlist functionality
    let playlist = [];
    let currentTrackIndex = 0;

    function openPlaylist() {
      playlist = [];
      const rows = document.querySelectorAll('#fileList tr');
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      
      rows.forEach(row => {
        const name = row.getAttribute('data-name');
        const isAudio = row.getAttribute('data-is-audio') === 'true';
        if (isAudio) {
          const fullPath = basePath ? basePath + '/' + name : name;
          playlist.push({ name, path: fullPath });
        }
      });

      if (playlist.length === 0) {
        alert('No audio files found in this directory');
        return;
      }

      renderPlaylist();
      currentTrackIndex = 0;
      playTrack(0);
      document.getElementById('playlistModal').classList.add('active');
    }

    function closePlaylist() {
      document.getElementById('playlistModal').classList.remove('active');
      document.getElementById('audioPlayer').pause();
    }

    function renderPlaylist() {
      const container = document.getElementById('playlistItems');
      container.innerHTML = '';
      
      playlist.forEach((track, index) => {
        const div = document.createElement('div');
        div.className = 'playlist-item';
        div.textContent = `${index + 1}. ${track.name}`;
        div.onclick = () => playTrack(index);
        container.appendChild(div);
      });
    }

    function playTrack(index) {
      currentTrackIndex = index;
      const track = playlist[index];
      const player = document.getElementById('audioPlayer');
      player.src = `/${track.path}?download=true`;
      player.play();
      
      // Update active state
      document.querySelectorAll('.playlist-item').forEach((item, i) => {
        if (i === index) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });
    }

    function addToPlaylist(name) {
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPath = basePath ? basePath + '/' + name : name;
      
      if (!playlist.find(t => t.name === name)) {
        playlist.push({ name, path: fullPath });
      }
      
      openPlaylist();
    }

    // Auto-play next track
    document.getElementById('audioPlayer').addEventListener('ended', () => {
      if (currentTrackIndex < playlist.length - 1) {
        playTrack(currentTrackIndex + 1);
      }
    });

    // Share functionality
    let currentSharePath = '';

    function shareFile(name) {
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      currentSharePath = basePath ? basePath + '/' + name : name;
      
      document.getElementById('shareResult').classList.add('hidden');
      document.getElementById('createShareBtn').style.display = 'block';
      document.getElementById('shareModal').classList.add('active');
    }

    function closeShareModal() {
      document.getElementById('shareModal').classList.remove('active');
    }

    async function createShare() {
      const expiry = document.getElementById('shareExpiry').value;
      
      const formData = new FormData();
      formData.append('path', currentSharePath);
      if (expiry) {
        formData.append('expiresIn', expiry);
      }
      
      const res = await fetch('/api/share', { method: 'POST', body: formData });
      if (res.ok) {
        const data = await res.json();
        const fullUrl = window.location.origin + data.url;
        document.getElementById('shareLink').value = fullUrl;
        document.getElementById('shareResult').classList.remove('hidden');
        document.getElementById('createShareBtn').style.display = 'none';
      } else {
        alert('Failed to create share link');
      }
    }

    function copyShareLink() {
      const input = document.getElementById('shareLink');
      input.select();
      document.execCommand('copy');
      alert('Link copied to clipboard!');
    }

    // Comments functionality
    let currentCommentPath = '';

    async function showComments(name) {
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      currentCommentPath = basePath ? basePath + '/' + name : name;
      
      await loadComments();
      document.getElementById('commentsModal').classList.add('active');
    }

    function closeCommentsModal() {
      document.getElementById('commentsModal').classList.remove('active');
    }

    async function loadComments() {
      const res = await fetch(`/api/comments?path=${encodeURIComponent(currentCommentPath)}`);
      if (res.ok) {
        const comments = await res.json();
        const container = document.getElementById('commentsList');
        
        if (comments && comments.length > 0) {
          container.innerHTML = comments.map(c => `
            <div class="bg-gray-700 p-3 rounded">
              <div class="flex justify-between items-start mb-2">
                <span class="font-bold">${escapeHtml(c.author)}</span>
                <span class="text-xs text-gray-400">${new Date(c.created_at).toLocaleString()}</span>
              </div>
              <p class="text-gray-300">${escapeHtml(c.content)}</p>
            </div>
          `).join('');
        } else {
          container.innerHTML = '<p class="text-gray-400 text-center">No comments yet</p>';
        }
      }
    }

    document.getElementById('commentForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const author = document.getElementById('commentAuthor').value || 'Anonymous';
      const content = document.getElementById('commentContent').value;
      
      if (!content) return;
      
      const formData = new FormData();
      formData.append('path', currentCommentPath);
      formData.append('author', author);
      formData.append('content', content);
      
      const res = await fetch('/api/comment', { method: 'POST', body: formData });
      if (res.ok) {
        document.getElementById('commentAuthor').value = '';
        document.getElementById('commentContent').value = '';
        await loadComments();
      } else {
        alert('Failed to add comment');
      }
    });

    // Download as ZIP
    async function downloadZip(name) {
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPath = basePath ? basePath + '/' + name : name;
      
      window.location.href = `/api/download-zip?path=${encodeURIComponent(fullPath)}`;
    }

    // Bulk actions
    function bulkActions() {
      document.getElementById('bulkModal').classList.add('active');
    }

    function closeBulkModal() {
      document.getElementById('bulkModal').classList.remove('active');
    }

    async function bulkDownloadZip() {
      const selected = getSelectedFiles();
      if (selected.length === 0) return;
      
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      const fullPaths = selected.map(name => basePath ? basePath + '/' + name : name);
      
      // Create a temporary form to submit the paths
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '/api/bulk-download-zip';
      form.style.display = 'none';
      
      // Add paths as JSON in a hidden input
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = 'paths';
      input.value = JSON.stringify(fullPaths);
      form.appendChild(input);
      
      document.body.appendChild(form);
      
      // Submit via fetch to get the file
      try {
        const response = await fetch('/api/bulk-download-zip', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(fullPaths)
        });
        
        if (response.ok) {
          // Get the blob and download it
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `files_${Date.now()}.zip`;
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          document.body.removeChild(a);
        } else {
          alert('Failed to create ZIP file');
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
      
      document.body.removeChild(form);
      closeBulkModal();
    }

    async function bulkDelete() {
      const selected = getSelectedFiles();
      if (selected.length === 0) return;
      
      if (!confirm(`Delete ${selected.length} items?`)) return;
      
      const basePath = currentPath === '/' ? '' : currentPath.substring(1);
      
      for (const name of selected) {
        const fullPath = basePath ? basePath + '/' + name : name;
        await fetch(`/api/delete?path=${encodeURIComponent(fullPath)}`, { method: 'DELETE' });
      }
      
      location.reload();
    }

    // Copy to clipboard functionality
    document.addEventListener('keydown', async (e) => {
      // Ctrl/Cmd + C for copy path
      if ((e.ctrlKey || e.metaKey) && e.key === 'c') {
        const selected = getSelectedFiles();
        if (selected.length > 0) {
          const basePath = currentPath === '/' ? '' : currentPath.substring(1);
          const paths = selected.map(name => basePath ? basePath + '/' + name : name);
          
          // Store in sessionStorage for paste
          sessionStorage.setItem('copiedFiles', JSON.stringify(paths));
          
          // Visual feedback
          const bulkBtn = document.getElementById('bulkBtn');
          const originalText = bulkBtn.textContent;
          bulkBtn.textContent = 'üìã Copied!';
          setTimeout(() => {
            bulkBtn.textContent = originalText;
          }, 1000);
        }
      }
      
      // Ctrl/Cmd + V for paste (move files)
      if ((e.ctrlKey || e.metaKey) && e.key === 'v') {
        const copiedFiles = sessionStorage.getItem('copiedFiles');
        if (copiedFiles) {
          const files = JSON.parse(copiedFiles);
          const targetPath = currentPath === '/' ? '' : currentPath.substring(1);
          
          for (const srcPath of files) {
            const fileName = srcPath.split('/').pop();
            const dstPath = targetPath ? targetPath + '/' + fileName : fileName;
            
            const formData = new FormData();
            formData.append('srcPath', srcPath);
            formData.append('dstPath', dstPath);
            
            await fetch('/api/copy', { method: 'POST', body: formData });
          }
          
          sessionStorage.removeItem('copiedFiles');
          location.reload();
        }
      }
    });

  </script>

</body>
</html>
